!function(e){function t(e){e&&(this.promise=e)}var r=e.Promise;r||(t.prototype.resolved=!1,t.prototype.rejected=!1,t.prototype.resolvedValue=void 0,t.prototype.rejectedValue=void 0,t.prototype.resolve=function(e){this.resolved||this.rejected||(this.resolved=!0,this.resolvedValue=e),this.promise&&this.promise.tick()},t.prototype.reject=function(e){this.resolved||this.rejected||(this.rejected=!0,this.rejectedValue=e),this.promise&&this.promise.tick()},r=e.Promise=function(e){if(e){var r=this.deferred=new t(this);try{e(r.resolve.bind(r),r.reject.bind(r))}catch(o){r.reject(o)}}},r.prototype.thenMethod=void 0,r.prototype.thenMethodEvaluated=!1,r.prototype.catchMethodEvaluated=!1,r.prototype.thenMethodResult=void 0,r.prototype.nextPromise=void 0,r.prototype.transferred=!1,r.defer=function(){var e=new r;return e.deferred=new t(e),e.deferred},r.toPromise=function(e){return e instanceof r?e:e instanceof Error?r.reject(e):r.resolve(e)},r.resolve=function(e){var o=new r,n=o.deferred=new t(o);return n.resolved=!0,n.resolvedValue=e,o},r.reject=function(e){var o=new r,n=o.deferred=new t(o);return n.rejected=!0,n.rejectedValue=e,o},r.all=function(e){var t=[],o=0,n=r.defer();return e.forEach(function(i,s){r.toPromise(i).then(function(r){t[s]=r,o++,o==e.length&&n.resolve(t)})["catch"](function(e){n.reject(e)})}),n.promise},e.Promise.prototype.all=function(){return this.then(function(e){return!e.constructor===Array&&(e=[e]),r.all(e)})},r.race=function(e){var t=!1,o=r.defer();return e.forEach(function(e,n){r.toPromise(e).then(function(e){t||(t=!0,o.resolve(e))})["catch"](function(e){t||(t=!0,o.reject(e))})}),o.promise},r.prototype.tick=function(){if(this.deferred){if(this.deferred.resolved){if(!this.thenMethodEvaluated&&this.thenMethod)try{var e=this.thenMethod(this.deferred.resolvedValue);this.thenMethodResult=r.toPromise(e),this.thenMethodEvaluated=!0}catch(o){var n=this.deferred=new t(this);n.rejected=!0,n.rejectedValue=o}this.thenMethodEvaluated&&this.nextPromise&&(this.nextPromise.deferred=this.thenMethodResult.deferred,this.nextPromise.deferred.promise=this.nextPromise,this.nextPromise.tick())}this.deferred.rejected&&(this.catchMethod?this.catchMethodEvaluated||(this.catchMethod(this.deferred.rejectedValue),this.catchMethodEvaluated=!0):this.nextPromise&&this.nextPromise.reject(this.deferred.rejectedValue))}},r.prototype.resolve=function(e){if(!this.deferred)throw new Error("missing deferred");this.deferred.resolve(e)},r.prototype.reject=function(e){this.deferred||(this.deferred=new t(this)),this.deferred.reject(e)},r.prototype["catch"]=function(e){if(this.catchMethod)throw new Error("already have a catch method");return this.catchMethod=e,setTimeout(this.tick.bind(this),0),this},r.prototype.then=function(e,t){if(this.thenMethod)throw new Error("already have a then method");return this.thenMethod=e,this.nextPromise||(this.nextPromise=new r),t?this["catch"](t):(setTimeout(this.tick.bind(this),0),this.nextPromise)}),e.Promise.npost=function(e,t,o){return new r(function(r,n){o.push(function(e){if(e)n(e);else{var t=arguments[1];if(arguments.length>2){t=[];for(var o=1;o<arguments.length;o++)t.push(arguments[o])}r(t)}}),("string"==typeof t?e[t]:t).apply(e,o)})},e.Promise.ninvoke=function(e,t){var o=[].slice.call(arguments,2);return r.npost(e,t,o)},e.Promise.nbind=function(e,t){return function(){var o=[].slice.call(arguments);return r.npost(e,t,o)}},e.Promise.denodify=function(e){return function(){var t=[].slice.call(arguments);return r.npost(null,e,t)}},e.Promise.nfapply=function(e,t){return r.npost(null,e,t)},e.Promise.nfcall=function(e){var t=[].slice.call(arguments,1);return r.npost(null,e,t)},e.Promise.prototype.spread=function(e){return this.then(function(t){return t.constructor===Array?e.apply(this,t):e(t)})},e.Promise.delay=function(e){return new r(function(t,r){setTimeout(t,e||0)})},e.Promise.fcall=function(e){var t;try{t=e()}catch(o){t=o}return t instanceof r?t:t instanceof Error?r.reject(t):r.resolve(t)},"undefined"!=typeof module&&(module.exports=r)}("undefined"==typeof global?window:global);